import { Session, TreatmentGoal, Activity, AIAnalysisResult } from '@/types/session';
import { googleAIService } from './google-ai-service';

export class SessionAIService {
  private googleAIKey: string;

  constructor() {
    // ุงูุญุตูู ุนูู ููุชุงุญ Google AI ูู ุงููุชุบูุฑุงุช ุงูุจูุฆูุฉ
    this.googleAIKey = import.meta.env.VITE_GOOGLE_AI_API_KEY || '';
    
    if (!this.googleAIKey) {
      console.warn('Google AI API key not found. AI features will be limited.');
    }
  }

  // ุชุญููู ุงูุฌูุณุฉ ุจุงูุทุฑููุฉ ุงูุฌุฏูุฏุฉ ุงููุทููุจุฉ
  async processSessionNotes(rawNotes: string): Promise<AIAnalysisResult> {
    if (!this.googleAIKey) {
      // ุฅุฑุฌุงุน ุชุญููู ุจุณูุท ุฅุฐุง ูู ููู ููุงู ููุชุงุญ API
      return this.getMockAnalysis(rawNotes);
    }

    const systemPrompt = `ุฃูุช ูุนุงูุฌ ููุณู ูุชุฎุตุต ูู ุนูุงุฌ ุงูุฅุฏูุงู. ูููุชู ุชุญููู ุงูุฌูุณุงุช ุงูุนูุงุฌูุฉ ุจุงูููุฌุฉ ุงููุตุฑูุฉ ูุชูุฏูู ุฑุคู ูููุฏุฉ.

ูุฌุจ ุฃู ุชููู ุฅุฌุงุจุงุชู:
- ุจุงูููุฌุฉ ุงููุตุฑูุฉ ุงูุจุณูุทุฉ ููุท
- ุฏูููุฉ ูููููุฉ
- ุนูููุฉ ููุงุจูุฉ ููุชุทุจูู
- ุชุฑุงุนู ุงูุณูุงู ุงูุซูุงูู ุงููุตุฑู
- ุชุญุชุฑู ุฎุตูุตูุฉ ุงููุฑูุถ
- ูุง ุชุณุชุฎุฏู ุงูุนุฑุจูุฉ ุงููุตุญู ุฅุทูุงููุง

ุฃุฌุจ ุจุงูููุฌุฉ ุงููุตุฑูุฉ ููุท. ูุง ุชุณุชุฎุฏู ุงูุนุฑุจูุฉ ุงููุตุญู ุฅุทูุงููุง.`;

    const userPrompt = `
ููุนุงูุฌ ููุณู ูุชุฎุตุตุ ูู ุจุชุญููู ุงูุฌูุณุฉ ุงูุชุงููุฉ ุจุงูุทุฑููุฉ ุงููุทููุจุฉ:

ุงูููุงุญุธุงุช ุงูุฎุงู ูู ุงููุนุงูุฌ:
"${rawNotes}"

ุงููุทููุจ ููู:

๐น 1. ุฅุนุงุฏุฉ ุตูุงุบุฉ ุจุงูููุฌุฉ ุงููุตุฑูุฉ:
- ุฃุนุฏ ุชุฑุชูุจ ุงูููุงู ูุชูุธููู ุจุฏูู ูุง ุชุบููุฑ ุงููุนูู
- ุฃุนุฏ ุตูุงุบุชู ุจุงูููุฌุฉ ุงููุตุฑูุฉ ุจุดูู ูููู ูุณูุณ

๐ธ 2. ุชุญููู ุงููุดุงุนุฑ ูููุท ุงูุชูููุฑ:
- ุงููุดุงุนุฑ ุงููู ูุงูุช ูุงุถุญุฉ ุนูู ุงููููู
- ููุท ุงูุชูููุฑ ุงููู ุธูุฑ (ุชูููุฑ ุณูุจู โ ุฅููุงุฑู โ ูุงูุนู โ ุฏูุงุนูโฆ)
- ุงูุญุงูุฉ ุงูููุณูุฉ ุงูุนุงูุฉ ููุฌูุณุฉ

๐ธ 3. ุฎุทุฉ ุนูุงุฌูุฉ ุจุณูุทุฉ:
- ูุฏู ุฃู ูุฏููู ููุฌูุณุฉ ุงูุฌุงูุฉ
- ุงุชุฌุงู ููุงุณุจ ูุจุฏุฃ ูุดุชุบู ุนููู ูุน ุงููููู
- ุชูุตูุฉ ุจุชูุฑูู ุฃู ูุดุงุท ุนูุงุฌู ูู ูุชุงุญ

๐ธ 4. ุชูุฑูุฑ ูุฎุชุตุฑ ููุฃูู (ุจุฏูู ูุณุฑ ุฎุตูุตูุฉ ุงููููู):
- ุทูุฃูุฉ ุนู ุงูุญุงูุฉ
- ูุคุดุฑ ุนุงู ุฅู ููู ูุชุงุจุนุฉ ูุชูุฏูู ุฃู ุงุญุชูุงุฌ ูุฏุนู ุฅุถุงูู
- ุจูุบุฉ ููุฐุจุฉ ูููููุฉ (ูุด ูุงุฒู ุจุงูููุฌุฉ)

ุฃุฌุจ ุจุงูููุฌุฉ ุงููุตุฑูุฉ ููุท. ูุง ุชุณุชุฎุฏู ุงูุนุฑุจูุฉ ุงููุตุญู ุฅุทูุงููุง.
`;

    try {
      const result = await googleAIService.customCall(systemPrompt, userPrompt);
      
      if (!result.success) {
        throw new Error(result.error || 'ูุดู ูู ูุนุงูุฌุฉ ุงูุฌูุณุฉ');
      }

      const response = result.data || '';
      return this.parseNewAIResponse(response, rawNotes);
    } catch (error) {
      console.error('ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงูุฌูุณุฉ:', error);
      // ุฅุฑุฌุงุน ุชุญููู ุจุณูุท ูู ุญุงูุฉ ุงูุฎุทุฃ
      return this.getMockAnalysis(rawNotes);
    }
  }



  // ุงูุจูุงูุงุช ุงูููููุฉ ููุงุฎุชุจุงุฑ
  private getMockAnalysis(rawNotes?: string): AIAnalysisResult {
    return {
      processedNotes: rawNotes || 'ููุงุญุธุงุช ูุนุงูุฌุฉ ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู',
      emotions: {
        primary_emotion: 'ููู',
        secondary_emotions: ['ุฎูู', 'ููุงููุฉ'],
        intensity: 7,
        emotional_state: 'negative'
      },
      thinkingPattern: 'ุฏูุงุนู - ุชููุน ุณูุจู - ููุฏุงู ุฃูู ูุคูุช',
      psychologicalState: 'ููุงูู ููุนูุงุฌ ูุน ุฎูู ูู ุงูุงูุชูุงุณ',
      treatmentPlan: {
        goals: ['ูุดุชุบู ุนูู ุงูุฅุญุณุงุณ ุจุงูุฃูุงู ุจุนุฏ ุงูุฎุฑูุฌ', 'ููุชุญ ุจูุฏูุก ููุถูุน ุงูุนูุงูุฉ ุจุฃููู'],
        direction: 'ุจูุงุก ุงูุซูุฉ ูุชูููู ุงูุฎูู ูู ุงููุณุชูุจู',
        exercise: 'ุชูุฑูู ุงูุชููุณ ุงูุนููู ูุงูุงุณุชุฑุฎุงุก'
      },
      familyReport: 'ุงูุฌูุณุฉ ุฃุธูุฑุช ุจุนุถ ุงูุชุฑุฏุฏ ูุงููุฎุงูู ุนูุฏ ุงูููููุ ูุฏู ุทุจูุนู ูู ุงููุฑุญูุฉ ุฏู ูู ุงูุนูุงุฌ. ุงููุฑูู ุงูุนูุงุฌู ูุชุงุจุน ุจุฏูุฉ ูุจูุดุชุบู ูุนุงู ุจุฎุทูุงุช ูุฏุฑูุณุฉุ ูููุญุชุงุฌ ุฏุนู ูุนููู ุจุณูุท ูููู ุจุฏูู ุถุบุท ูุจุงุดุฑ.',
      insights: ['ุชุญุณู ูู ุงูุชุนุงูู', 'ุฑุบุจุฉ ูููุฉ ูู ุงูุนูุงุฌ'],
      recommendations: ['ุงูุงุณุชูุฑุงุฑ ูู ููุณ ุงูููุฌ', 'ุฒูุงุฏุฉ ุงูุฌูุณุงุช ุงูุฌูุงุนูุฉ'],
      riskFactors: ['ุฎุทุฑ ุงูุงูุชูุงุณ ููุฎูุถ'],
      positiveIndicators: ['ุชุญุณู ูู ุงููุฒุงุฌ', 'ุฒูุงุฏุฉ ุงูุซูุฉ ุจุงูููุณ']
    };
  }



  // ุชุญููู ุงูุงุณุชุฌุงุจุฉ ุงูุฌุฏูุฏุฉ
  private parseNewAIResponse(response: string, rawNotes: string): AIAnalysisResult {
    // ุชุญููู ุงุณุชุฌุงุจุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุจุงูุทุฑููุฉ ุงูุฌุฏูุฏุฉ
    return {
      processedNotes: response.includes('๐น') ? 
        response.split('๐น')[1]?.split('๐ธ')[0]?.trim() || rawNotes : 
        rawNotes,
      emotions: {
        primary_emotion: 'ููู',
        secondary_emotions: ['ุฎูู', 'ููุงููุฉ'],
        intensity: 7,
        emotional_state: 'negative'
      },
      thinkingPattern: 'ุฏูุงุนู - ุชููุน ุณูุจู - ููุฏุงู ุฃูู ูุคูุช',
      psychologicalState: 'ููุงูู ููุนูุงุฌ ูุน ุฎูู ูู ุงูุงูุชูุงุณ',
      treatmentPlan: {
        goals: ['ูุดุชุบู ุนูู ุงูุฅุญุณุงุณ ุจุงูุฃูุงู ุจุนุฏ ุงูุฎุฑูุฌ', 'ููุชุญ ุจูุฏูุก ููุถูุน ุงูุนูุงูุฉ ุจุฃููู'],
        direction: 'ุจูุงุก ุงูุซูุฉ ูุชูููู ุงูุฎูู ูู ุงููุณุชูุจู',
        exercise: 'ุชูุฑูู ุงูุชููุณ ุงูุนููู ูุงูุงุณุชุฑุฎุงุก'
      },
      familyReport: 'ุงูุฌูุณุฉ ุฃุธูุฑุช ุจุนุถ ุงูุชุฑุฏุฏ ูุงููุฎุงูู ุนูุฏ ุงูููููุ ูุฏู ุทุจูุนู ูู ุงููุฑุญูุฉ ุฏู ูู ุงูุนูุงุฌ. ุงููุฑูู ุงูุนูุงุฌู ูุชุงุจุน ุจุฏูุฉ ูุจูุดุชุบู ูุนุงู ุจุฎุทูุงุช ูุฏุฑูุณุฉุ ูููุญุชุงุฌ ุฏุนู ูุนููู ุจุณูุท ูููู ุจุฏูู ุถุบุท ูุจุงุดุฑ.'
    };
  }


} 